@using WebMatrix.Data;
@using WebMatrix.WebData;
@{ // MemberShip Code



    // c# Database code
    string connectionString = @"Data Source=(LocalDB)\MSSQLLocalDB;AttachDbFilename=|DataDirectory|\Gift_database.mdf;Integrated Security=True";
    string provider = "System.Data.SqlClient";
    Database db = Database.OpenConnectionString(connectionString, provider);

    // form variable
    string ID = null;
    string Clist = null;
    Boolean refresh = false;
    var Creator_Name = WebSecurity.CurrentUserName;
    string Numberlist = Request["ChooseList"];
    if (Request["ChooseList"] != null)
    {
        Clist = Request["ChooseList"];
    }
    else
    {
        Clist = Session["NumberList"] as string;
    }
    dynamic giftkey = null;
    if (Session["NumberList"] as string != @Request["ChooseList"] && Session["Numberlist"] != null)
    {
        Numberlist = @Request["ChooseList"];
        Clist = Session["NumberList"] as string;
        //giftkey = Session["Giftkey"];
    }
    else
    {
        Clist = Session["NumberList"] as string;
    }
    if (Session["NumberList"] != null) { Clist = Session["NumberList"] as string; }

    int priority = 0;
    string strpriority = null;
    string CountList = null;
    dynamic Listvalue = null;
    string AddGift = "dont";




    dynamic Newlist = null;
    Newlist = Request["Newlist"];
    bool insertlist = false;
    List<string> Giftlist = new List<string>();
    List<string> oldgiftlist = new List<string>();
    List<int> Priority = new List<int>();


    oldgiftlist = Session["GiftList"] as List<string>;


    if (Session["NumberList"] == null)
    {
        Numberlist = Request["ChooseList"];
    }
    else
    {
        Numberlist = Session["NumberList"] as string;
    }
    Session["NumberList"] = null;
    if (Newlist != null)
    {
        foreach (dynamic row in db.Query("select distinct Creators_ListID, count(Creators_ListID) as CountOf from Gifts Where Creator_Name='" + Creator_Name + "' group by Creators_ListID"))
        {
            int Liststring = row.Creators_Listid;
            if (Liststring.ToString() == Newlist)
            {
                insertlist = false;
                break;
            }
            else
            {
                insertlist = true;
            }

        }
        if (insertlist == true)
        {
            db.Execute("insert INTO Gifts (Gift,GiftKey,Priority,Creator_Name,Creators_ListID) VALUES('','1','1','" + Creator_Name + "','" + Newlist + "')");
        }
    }
    dynamic Giftquery = db.Query("Select * from Gifts where Creators_ListID = '" + Numberlist + "' AND Creator_Name = '" + Creator_Name + "'");
    dynamic giftrequest = null;
    int listcount = 0;


    dynamic SelectListQueury = null;
    SelectListQueury = db.Query("select distinct Creators_ListID, count(Creators_ListID) as CountOf from Gifts Where Creator_Name='" + Creator_Name + "' group by Creators_ListID");


    if (Request["Giftkey"] != null) {
        giftkey = Request["GiftKey"];
    }
    List<string> alteredlist = new List<string>();
    int count = 0;

    if (oldgiftlist != null && Request["Gift" + count] != null)
    {
        foreach (dynamic row in oldgiftlist)
        {
            giftrequest = Request["Gift" + count];
            strpriority = Request["Priority Gift" + count];
            priority = Convert.ToInt16(strpriority);
            Priority.Add(priority);
            alteredlist.Add(giftrequest);
            count++;
        }
        count = 0;
        foreach (dynamic row in alteredlist)
        {
            db.Execute("update Gifts set Gift = '" + alteredlist[count] + "' , GiftKey = '" + giftkey + "', Priority = '" + Priority[count] + "' where Gift = '" + oldgiftlist[count] + "' AND Creators_ListID = '" + Numberlist + "' AND Creator_Name = '" + Creator_Name + "' ");

            count++;
        }


    }


    //if (false == giftkey.IsEmpty())
    //{
    //    db.Execute(insertQuery, Creator_Name, gift1, gift2, gift3, gift4, giftkey);
    //    // Response.Redirect("~/AccountPage.cshtml");

    //}
}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Account Page</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta charset="utf-8" />
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="~/materialize.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="~/js/materialize.js"></script>


</head>
<body>
    <!--Navigatie header-->
    <nav>
        <div class="nav-wrapper red">
            <a href="~/index.cshtml" class="brand-logo right">GiftTool!</a>
            <ul id="nav-mobile" class="left">
                <li><a href="#">Account</a></li>

            </ul>
        </div>
    </nav>
    <!-- SideNav Button-->
    <div class=" row">
        <div class=" col s1 m1 l1">
            <ul>
                <li><a href="#" data-activates="slide-out" class="button-collapse waves-effect"><i class="material-icons">menu</i> </a></li>
            </ul>
        </div>
    </div>
    <!-- Page Layout here -->
    <div class="row">
        <div class=" col s5 m5 l5">
            <form method="post">
                <div class="row">
                    <div class=" input-field col s10 m10 l10">
                        <select name="ChooseList">
                            <option value="@Numberlist" selected>@Numberlist  </option>
                            @{ int Giftcount = 0;
                                dynamic uniqueListID = db.Query("select distinct Creators_ListID, count(Creators_ListID) as CountOf from Gifts Where Creator_Name='" + Creator_Name + "' group by Creators_ListID");
                                foreach (dynamic row in uniqueListID)
                                {
                                    int CountListint = SelectListQueury[Giftcount].Creators_ListID;
                                    CountList = CountListint.ToString();
                                    <option value="@CountList">@CountList</option>
                                    Giftcount++;

                                }
                                if (Request["ChooseList"] != null) {
                                    refresh = true;
                                }
                                }

                        </select>
                        <label>Choose your GiftList</label>
                    </div>
                    <button class="btn waves-effect waves-light" type="submit" name="action">
                        Submit
                        <i class="material-icons right">send</i>
                    </button>
                </div>
            </form>
        </div>
        <form method="post">
            <div class=" = col s6 m6 l6">
                <div class=" input-field">
                    <input name="Newlist" id="Newlist" type="text" class="validate" value="@Newlist" />
                    <label for="Newlist">New list</label>
                </div>
                <button class="btn waves-effect waves-light" type="submit" name="action">
                        Create NewList                     
                    </button>
            </div>
        </form>
    </div>



    <form method="post">
        @{

            int Listcount = 0;

            foreach (dynamic row in Giftquery)
            {
                String Name = "Gift" + Listcount;
                string PName = "Priority Gift" + Listcount;

                if (alteredlist.Count == 0)
                {
                    Listvalue = Giftquery[Listcount].Gift;
                    priority = Giftquery[Listcount].Priority;
                }
                else
                {
                    Listvalue = Giftquery[Listcount].Gift;
                    priority = Giftquery[Listcount].Priority;

                }
                <div class="input-field col s6">
                    <input value="@Listvalue" id="@Name" type="text" class="validate" name="@Name">
                    <label class="active" for="@Name">@Name </label>
                </div>
                <div class="input-field col s6">
                    <input value="@priority" id="@PName" type="number" class="validate" name="@PName">
                    <label class="active" for="@PName">@PName </label>
                </div>
                Listcount++;
                Giftlist.Add(Listvalue);
                Priority.Add(priority);

            }
            if (Giftlist.Count != 0 && Giftlist[0] != null)
            {
                if (Giftlist.Last<string>() != "" && Numberlist != null)
                {
                    db.Execute("insert INTO Gifts(Gift, GiftKey, Priority, Creator_Name, Creators_ListID) VALUES('', '1', '', '" + Creator_Name + "', ' " + Numberlist + "')");
                    refresh = true;
                }
            }

            giftkey = db.Query("Select GiftKey from Gifts where Creators_ListID = '" + Numberlist + "' AND Creator_Name = '" + Creator_Name + "'");
            { }
            if (giftkey.Count != 0)
            {
                <div class="input-field col s12">
                    <input value="@giftkey[0].GiftKey" id="Giftkey" type="text" class="validate" name="GiftKey"  required >
                    <label class="active" for="Giftkey">Giftkey</label>
                </div>
            }
            if (Request["GiftKey"] != null) {
                refresh = true;
            }
        }

        <div class="row col s4 m4 l4">

            <button class="btn waves-effect waves-light" type="submit" name="submit">
                Submit
                <i class="material-icons right">send</i>

            </button>
        </div>
    </form>
    <!--Side NAV for Users-->
    <ul id="slide-out" class="side-nav">

        <li>
            <a class="waves-effect" href="~/index.cshtml">Home <i class="material-icons">home</i></a>
        </li>
        @{if (WebSecurity.IsAuthenticated == false)
        {
            <li>
                <a class="waves-effect" href="~/Account/LoginPage.cshtml"> LogIn  </a>
            </li>
            <li>
                <div class="divider"></div>
            </li>
            <li>
                <a class="waves-effect" href="~/Account/SignIn.cshtml">Signin</a>
            </li>
            }
            else
            {
        <li>
            <a class="waves-effect" href="~/Account/Logout.cshtml">Logout <i class="material-icons">Logout</i></a>
        </li>

            }
        }
    </ul>
          

    

    <!--C#-->
    @{
        AddGift = "";
        Session["GiftList"] = Giftlist;
        Session["SPriority"] = Priority;
        Session["GiftKey"] = giftkey;
       
        if (Request["ChooseList"] != null)
        {

            Session["NumberList"] = Request["ChooseList"]; ;
            //string test = Request["ChooseList"];
            //Clist = Session["NumberList"] as string;
        }
        else
        {

            Session["NumberList"] = Numberlist;
        }

        if (Request["Newlist"] != null)
        {
            Session["NumberList"] = Newlist;
            refresh = true;
        }
        if (refresh == true)
        {
            Response.Redirect("~/Members/AccountPage");
        }

        }

    <!--Scripts-->
    <script>
        // Initialize collapse button
        $(".button-collapse").sideNav();
        // initialize select dropdown
        $(document).ready(function () {
        $('select').material_select();
        });

    </script>
</body>

</html>